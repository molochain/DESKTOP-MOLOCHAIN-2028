<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molochain Cross-Subdomain Auth Integration Report</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 2rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary); }
        h2 { font-size: 1.5rem; margin: 2rem 0 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border); }
        h3 { font-size: 1.25rem; margin: 1.5rem 0 0.75rem; }
        .meta { color: var(--text-muted); margin-bottom: 2rem; }
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .status-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid var(--success);
        }
        .status-card.warning { border-left-color: var(--warning); }
        .status-card.danger { border-left-color: var(--danger); }
        .status-card h4 { font-size: 0.9rem; color: var(--text-muted); }
        .status-card .value { font-size: 1.25rem; font-weight: 600; }
        .status-card .status { font-size: 0.85rem; margin-top: 0.25rem; }
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--bg); font-weight: 600; }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        code {
            background: #f1f5f9;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Monaco', monospace;
            font-size: 0.85rem;
        }
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
        }
        pre code { background: none; color: inherit; padding: 0; }
        .issue-card {
            border-left: 4px solid var(--danger);
            padding-left: 1rem;
            margin: 1rem 0;
        }
        .issue-card.warning { border-left-color: var(--warning); }
        .mermaid { background: white; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
        .checklist { list-style: none; }
        .checklist li { padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem; }
        .checklist li::before { content: "‚òê"; font-size: 1.2rem; }
        .phase { margin-bottom: 2rem; }
        .phase-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .phase-number {
            background: var(--primary);
            color: white;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        @media print {
            body { padding: 0; }
            .card { break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cross-Subdomain Authentication Integration Report</h1>
        <p class="meta">Generated: December 21, 2025 | Server: 31.186.24.19</p>

        <h2>Executive Summary</h2>
        <div class="card">
            <p>This report documents the comprehensive audit of the centralized authentication system across all Molochain subdomains. The audit identified <strong>critical configuration gaps</strong> preventing seamless SSO (Single Sign-On) across subdomains.</p>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h4>auth.molochain.com</h4>
                <div class="value">200 OK</div>
                <div class="status"><span class="badge badge-success">Working</span></div>
            </div>
            <div class="status-card">
                <h4>molochain.com</h4>
                <div class="value">401 (Expected)</div>
                <div class="status"><span class="badge badge-success">Working</span></div>
            </div>
            <div class="status-card warning">
                <h4>opt.molochain.com</h4>
                <div class="value">401 (Expected)</div>
                <div class="status"><span class="badge badge-success">Working</span></div>
            </div>
            <div class="status-card warning">
                <h4>mololink.molochain.com</h4>
                <div class="value">401 (Expected)</div>
                <div class="status"><span class="badge badge-warning">CORS Missing</span></div>
            </div>
        </div>

        <h2>System Architecture</h2>
        <div class="card">
            <div class="mermaid">
graph TB
    subgraph "Client Layer"
        A[Browser] --> B[molochain.com]
        A --> C[mololink.molochain.com]
        A --> D[opt.molochain.com]
        A --> E[auth.molochain.com]
    end

    subgraph "Nginx Proxy Layer"
        B --> F[Nginx :443]
        C --> G[Nginx :443]
        D --> H[Nginx :443]
        E --> I[Nginx :443]
    end

    subgraph "Application Layer"
        F --> J[Express :5000]
        G --> K[Mololink :5001]
        H --> L[OTMS :3009]
        I --> M[Auth Service :7010]
    end

    subgraph "Kong Gateway"
        N[Kong :8000]
        K -.-> N
        L -.-> N
    end

    subgraph "Data Layer"
        O[(PostgreSQL :5432)]
        P[(Redis :6379)]
        J --> O
        K --> O
        L --> O
        M --> O
        M --> P
    end

    style M fill:#10b981,stroke:#059669,color:#fff
    style P fill:#f59e0b,stroke:#d97706,color:#fff
    style O fill:#2563eb,stroke:#1d4ed8,color:#fff
            </div>
        </div>

        <h2>Critical Issues Identified</h2>

        <div class="issue-card">
            <h3><span class="badge badge-danger">CRITICAL</span> Cookie Domain Not Configured</h3>
            <p>Session cookies are scoped to individual subdomains, preventing cross-subdomain SSO.</p>
            <p><strong>Current:</strong></p>
            <pre><code>cookie: {
  httpOnly: true,
  secure: isProd,
  sameSite: 'strict'  // Blocks cross-subdomain
}
// Missing: domain: '.molochain.com'</code></pre>
            <p><strong>Required Fix:</strong></p>
            <pre><code>cookie: {
  httpOnly: true,
  secure: true,
  sameSite: 'lax',
  domain: '.molochain.com'  // Enable cross-subdomain
}</code></pre>
        </div>

        <div class="issue-card">
            <h3><span class="badge badge-danger">CRITICAL</span> CORS Origins Missing Subdomains</h3>
            <table>
                <tr><th>Subdomain</th><th>Status</th></tr>
                <tr><td>molochain.com</td><td><span class="badge badge-success">Configured</span></td></tr>
                <tr><td>www.molochain.com</td><td><span class="badge badge-success">Configured</span></td></tr>
                <tr><td>opt.molochain.com</td><td><span class="badge badge-success">Configured</span></td></tr>
                <tr><td>app.molochain.com</td><td><span class="badge badge-success">Configured</span></td></tr>
                <tr><td>mololink.molochain.com</td><td><span class="badge badge-danger">MISSING</span></td></tr>
                <tr><td>auth.molochain.com</td><td><span class="badge badge-danger">MISSING</span></td></tr>
                <tr><td>admin.molochain.com</td><td><span class="badge badge-danger">MISSING</span></td></tr>
            </table>
        </div>

        <div class="issue-card warning">
            <h3><span class="badge badge-warning">MEDIUM</span> Kong Gateway Has No JWT Plugin</h3>
            <p>No authentication plugins are enabled at the gateway level. All auth validation happens at application level.</p>
            <pre><code>curl http://localhost:8001/plugins
{
  "data": [],  // Empty - no plugins
  "next": null
}</code></pre>
        </div>

        <div class="issue-card warning">
            <h3><span class="badge badge-warning">MEDIUM</span> No Database Auth Triggers</h3>
            <p>Missing audit triggers for authentication events:</p>
            <ul>
                <li>on_user_created - Log new registrations</li>
                <li>on_login_success - Audit successful logins</li>
                <li>on_login_failure - Track failed attempts</li>
                <li>on_password_change - Audit password changes</li>
            </ul>
        </div>

        <h2>Authentication Flow</h2>
        <div class="card">
            <div class="mermaid">
sequenceDiagram
    participant U as User
    participant A as app.molochain.com
    participant Auth as auth.molochain.com
    participant Redis as Redis Session
    participant DB as PostgreSQL

    Note over U,DB: Current Flow (Per-Subdomain Login)
    U->>A: Access protected route
    A->>A: Check session cookie
    A-->>U: 401 Unauthorized
    U->>A: POST /api/auth/login
    A->>DB: Validate credentials
    DB-->>A: User data
    A->>Redis: Create session
    A-->>U: Set-Cookie (domain: app.molochain.com)
    
    Note over U,DB: SSO Flow (Required)
    U->>Auth: Redirect to auth.molochain.com/login
    Auth->>DB: Validate credentials
    DB-->>Auth: User data
    Auth->>Redis: Create session
    Auth-->>U: Set-Cookie (domain: .molochain.com)
    U->>A: Access with shared cookie
    A->>Redis: Validate session
    Redis-->>A: Session valid
    A-->>U: 200 OK + Protected content
            </div>
        </div>

        <h2>Service Configuration Details</h2>
        <div class="card">
            <h3>Docker Services</h3>
            <table>
                <tr><th>Service</th><th>Container</th><th>Internal Port</th><th>External Port</th><th>Status</th></tr>
                <tr><td>Central Auth</td><td>auth-service</td><td>3002</td><td>7010</td><td><span class="badge badge-success">Up 8+ days</span></td></tr>
                <tr><td>Redis Session</td><td>redis-session</td><td>6379</td><td>6379</td><td><span class="badge badge-success">Up 8+ days</span></td></tr>
                <tr><td>Kong Gateway</td><td>kong-gateway</td><td>8000</td><td>8000/8443</td><td><span class="badge badge-success">Up 7 days</span></td></tr>
                <tr><td>OTMS</td><td>otms-service</td><td>3009</td><td>3009</td><td><span class="badge badge-success">Up 7 days</span></td></tr>
                <tr><td>Mololink</td><td>mololink-app</td><td>5001</td><td>5001</td><td><span class="badge badge-success">Up 9 hours</span></td></tr>
            </table>
        </div>

        <div class="card">
            <h3>Kong Gateway Routes</h3>
            <table>
                <tr><th>Route Name</th><th>Hosts</th><th>Paths</th><th>Strip Path</th><th>Service Port</th></tr>
                <tr><td>mololink-route</td><td>mololink.molochain.com</td><td>/api, /</td><td>false</td><td>5001</td></tr>
                <tr><td>otms-route</td><td>-</td><td>/otms</td><td>true</td><td>3009</td></tr>
                <tr><td>otms-api-route-compat</td><td>-</td><td>/api</td><td>false</td><td>3009</td></tr>
            </table>
        </div>

        <h2>Recommended Action Plan</h2>

        <div class="phase">
            <div class="phase-header">
                <div class="phase-number">1</div>
                <h3>Critical Fixes (Immediate)</h3>
            </div>
            <ul class="checklist">
                <li>Update cookie configuration with <code>domain: '.molochain.com'</code></li>
                <li>Change <code>sameSite: 'strict'</code> to <code>sameSite: 'lax'</code></li>
                <li>Add mololink.molochain.com to CORS whitelist</li>
                <li>Add auth.molochain.com to CORS whitelist</li>
                <li>Add admin.molochain.com to CORS whitelist</li>
            </ul>
        </div>

        <div class="phase">
            <div class="phase-header">
                <div class="phase-number">2</div>
                <h3>Enhanced Security (Short-term)</h3>
            </div>
            <ul class="checklist">
                <li>Create audit_logs table if not exists</li>
                <li>Add database triggers for auth events</li>
                <li>Configure Kong JWT plugin</li>
                <li>Enable gateway-level token validation</li>
            </ul>
        </div>

        <div class="phase">
            <div class="phase-header">
                <div class="phase-number">3</div>
                <h3>Full SSO Implementation (Medium-term)</h3>
            </div>
            <ul class="checklist">
                <li>Create central login UI at auth.molochain.com</li>
                <li>Implement redirect flow for all subdomains</li>
                <li>Add cross-subdomain token refresh</li>
                <li>Implement silent token renewal</li>
            </ul>
        </div>

        <h2>Database Auth Tables</h2>
        <div class="card">
            <table>
                <tr><th>Table</th><th>Columns</th><th>Purpose</th></tr>
                <tr><td>users</td><td>19</td><td>User accounts</td></tr>
                <tr><td>refresh_tokens</td><td>8</td><td>JWT refresh tokens</td></tr>
                <tr><td>api_keys</td><td>9</td><td>API authentication</td></tr>
                <tr><td>admin_users</td><td>8</td><td>Admin accounts</td></tr>
                <tr><td>password_reset_tokens</td><td>5</td><td>Password reset</td></tr>
                <tr><td>user_roles</td><td>3</td><td>Role assignments</td></tr>
                <tr><td>permissions</td><td>4</td><td>Permission definitions</td></tr>
                <tr><td>audit_logs</td><td>6</td><td>Security audit</td></tr>
            </table>
        </div>

        <h2>Testing Checklist</h2>
        <div class="card">
            <h3>Cross-Subdomain Auth Tests</h3>
            <ul class="checklist">
                <li>Login on molochain.com, verify session on mololink.molochain.com</li>
                <li>Login on auth.molochain.com, verify session on opt.molochain.com</li>
                <li>Logout on one subdomain, verify logout on all subdomains</li>
                <li>Token refresh works across subdomains</li>
                <li>CORS allows requests from all subdomains</li>
                <li>Cookies set with <code>.molochain.com</code> domain</li>
            </ul>
        </div>

        <div style="margin-top: 3rem; padding-top: 1rem; border-top: 1px solid var(--border); color: var(--text-muted); font-size: 0.9rem;">
            <p><strong>Report Generated:</strong> December 21, 2025</p>
            <p><strong>Next Audit Scheduled:</strong> January 21, 2026</p>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
</body>
</html>
