services:
  admin-frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: molochain-admin-frontend
    restart: unless-stopped
    ports:
      - "7001:80"
    environment:
      - VITE_API_URL=
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
    networks:
      - molochain-core
    depends_on:
      - database-admin
      - ssl-checker
      - container-monitor
      - notification-service
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  database-admin:
    build:
      context: ../database-admin
      dockerfile: Dockerfile
    container_name: molochain-database-admin
    restart: unless-stopped
    environment:
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - PGHOST=${PGHOST:-molochain-db}
      - PGPORT=${PGPORT:-5432}
      - PGDATABASE=${PGDATABASE:-molochain}
      - PGUSER=${PGUSER:-molochain}
      - PGPASSWORD=${PGPASSWORD}
      - BACKUP_RETENTION_DAYS=7
    volumes:
      - postgres_backups:/var/backups/postgres
    networks:
      - molochain-core
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  ssl-checker:
    build:
      context: ../ssl-checker
      dockerfile: Dockerfile
    container_name: molochain-ssl-checker
    restart: unless-stopped
    environment:
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
    networks:
      - molochain-core
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 64M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  container-monitor:
    build:
      context: ../container-monitor
      dockerfile: Dockerfile
    container_name: container-monitor
    restart: unless-stopped
    environment:
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - DB_ADMIN_URL=http://molochain-database-admin:7003
      - CHECK_INTERVAL_SECONDS=30
      - MAX_RESTART_ATTEMPTS=3
      - RESTART_COOLDOWN_MINUTES=5
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - molochain-core
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 64M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  notification-service:
    build:
      context: ../notification-service
      dockerfile: Dockerfile
    container_name: notification-service
    restart: unless-stopped
    environment:
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - DB_ADMIN_URL=http://molochain-database-admin:7003
      - SSL_CHECKER_URL=http://molochain-ssl-checker:7002
      - CONTAINER_MONITOR_URL=http://container-monitor:7004
      - PGHOST=${PGHOST:-molochain-db}
      - PGPORT=${PGPORT:-5432}
      - PGDATABASE=${PGDATABASE:-molochain}
      - PGUSER=${PGUSER:-molochain}
      - PGPASSWORD=${PGPASSWORD}
    networks:
      - molochain-core
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  postgres_backups:
    driver: local

networks:
  molochain-core:
    external: true
